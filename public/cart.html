<!DOCTYPE html>
<html lang="en">

<head>
  <!-- 
    Author: Reuben Goh
    Admin num: P2205711
    Class: DISM2A03
   -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- jquery ui -->
  <link href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/69bb717c2f.js" crossorigin="anonymous"></script>
  <!--Favicon-->
  <link rel="icon" href="images/sp-games-logo.png" type="image/x-icon">
  <!-- other js scripts -->
  <script src="./js/general.js" defer></script>
  <title>Cart</title>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    $(async () => {
      $(document).ready(function () {
        loginStatus(localStorage["jwt"]);
      });

      // ==================== NON LOGGED IN USER CART ====================
      if (!localStorage["jwt"]) {
        // disable save card button
        $("#save-card").prop("disabled", true);

        // get cart data from session storage
        let cartData = sessionStorage["cart"];

        // empty cart
        if (cartData == undefined) {
          // display empty cart on page
          $("#cart-items").append(`
            <div class="row">
              <div class="col-12">
                <h3 class="text-center">Your cart is empty</h3>
                <h5 class="text-center">Continue browsing our games</h5>
              </div>
            </div>
            <div class="row">
              <div class="col-12 d-flex justify-content-center">
                <a class="btn btn-danger" id="back-to-games" href="./games.html">Game Store</a>
              </div>
            </div>
          `);

          $("#title-num-items").text("0 items");
        }

        // cart with data
        else {
          cartData = JSON.parse(cartData);

          // ==================== POPULATE CART ====================
          // set total cart items
          $("#title-num-items").text(cartData.length + " items");


          // ==================== POPULATE LEFT COL ====================
          // object to store prices to be used for right col (summary)
          var priceObj = {
            totalCost: 0
          };

          // main cart wrapper for left col
          let cartWrapper = $("#cart-items");

          // set items
          await cartData.forEach(async item => {
            let wrapper = $('<div class="row border-top" id="cart' + item.game_id + item.platform_id + '"></div>');
            let rowWrapper = $('<div class="row main align-items center"></div>');

            // get game details first
            const gameData = await gameDetailsFromId(item.game_id);
            const gamePlatArr = String(gameData.platform_id).split(",");
            const gamePriceArr = String(gameData.price).split(",");
            let itemPrice;

            await gamePlatArr.forEach((plat, index) => {
              if (Number(plat) === Number(item.platform_id)) {
                itemPrice = gamePriceArr[index];
              }
            });


            // set image
            let gameImg = $('<div class="col-2"><img class="img-fluid game-cart-img" src="./gameImage/' + gameData.img_name + '" alt="game image"></div>');


            // set title
            let titleWrapper = $('<div class="col"></div>');
            titleWrapper.append($('<div class="row text-muted>Game Item</div>'));

            // set platform icon
            let platformIdArr = [];
            let platformIconArr = [];
            if (!isNaN(Number(gameData.platform_id))) {
              platformIdArr.push(gameData.platform_id);
              platformIconArr.push(gameData.platform_icon);
            }

            else {
              platformIdArr = gameData.platform_id.split(",");
              platformIconArr = gameData.platform_icon.split(",");
            }
            let platformIcon;

            for (let i = 0; i < platformIdArr.length; i++) {
              if (Number(platformIdArr[i]) === Number(item.platform_id)) {
                platformIcon = platformIconArr[i];
              }
            }
            titleWrapper.append($('<div class="row">' + gameData.title + '<i class="' + platformIcon + ' p-0" style="color: #000000; font-size: 3vh;"></i></div>'));

            // set quantity
            let quantityWrapper = $('<div class="col d-flex justify-content-center"></div>');
            let quantityForm = $('<form class="quantity-form" id="form' + gameData.game_id + '"></form>');

            quantityForm.append($(`<input 
            type="number" 
            class="form-control game-item-quantity" 
            data-gameid="${item.game_id}"
            data-platformid="${item.platform_id}"
            value="${item.quantity}">`));

            quantityWrapper.append(quantityForm);


            // set price and delete button
            let priceWrapper = $('<div class="col d-flex justify-content-between align-items-start"></div>');
            priceWrapper.text("S$" + itemPrice);
            let deleteButton = $('<button class="btn btn-transparent delete-item p-0" data-gameid="' + item.game_id + '" data-platformid="' + item.platform_id + '"></button>');
            deleteButton.append($('<i class="fa-solid fa-trash" style="color: #000000;"></i>'));
            priceWrapper.append(deleteButton);

            // add to priceObj
            priceObj.totalCost += Number(itemPrice) * Number(item.quantity);
            priceObj[gameData.title] = (Number(itemPrice) * Number(item.quantity)).toFixed(2);

            // append to row wrapper
            rowWrapper.append(gameImg, titleWrapper, quantityWrapper, priceWrapper);
            wrapper.append(rowWrapper);
            cartWrapper.append(wrapper);


            // ==================== POPULATE RIGHT COL ====================
            // main cart wrapper for right col
            let summaryWrapper = $("#summary-items");

            // set total items
            $("#summary-num-items").text("ITEMS: " + cartData.length);
            $("#total-cost").text("S$ " + priceObj.totalCost.toFixed(2));

            let row = $('<div class="row d-flex justify-content-between my-2 p-0"></div>');
            let gameItem = $('<div class="col p-0">' + gameData.title + '</div>');
            let priceOfItem = $('<div class="col ps-2 text-end">S$ ' + (itemPrice * item.quantity).toFixed(2) + '</div>');

            row.append(gameItem, priceOfItem);
            summaryWrapper.append(row);

            // final cost (shipping free, hence same as total cost)
            $("#final-cost").text("S$ " + priceObj.totalCost.toFixed(2));


            // ==================== CHANGE QUANTITY EVENT ====================
            $(".game-item-quantity").on("input", async function () {
              await sleep(1000);

              if ($(this).val() < 1) {
                return;
              }
              const $this = $(this);

              // get game id
              let updateQuantityGameId = Number($this.data("gameid"));
              let updateQuantityPlatformId = Number($this.data("platformid"));

              // get new quantity
              let newQuantity;
              if (item.game_id === updateQuantityGameId && item.platform_id === updateQuantityPlatformId) {
                newQuantity = Number($this.val());
                console.log("new quantity ", newQuantity)
                item.quantity = newQuantity;
              }

              // update session storage
              sessionStorage.setItem("cart", JSON.stringify(cartData));
              window.location.reload();
            });


            // ==================== DELETE ITEM EVENT ====================
            $(".delete-item").click(function () {
              // get game id and platform id from button id
              const deleteGameId = $(this).data("gameid");
              const deletePlatformId = $(this).data("platformid");

              // remove item from cart
              cartData.forEach((cartItem, index) => {
                if (cartItem.game_id === deleteGameId && cartItem.platform_id === deletePlatformId) {
                  cartData.splice(index, 1);
                }
              });

              // update session storage
              sessionStorage.setItem("cart", JSON.stringify(cartData));
              window.location.reload();
            });
          });
          $("#summary-items").append("<hr>");
        }
      }

      // ==================== LOGGED IN USER CART ====================
      else {
        try {
          // ==================== GET USER'S CARD DETAILS (if any) ====================
          var settings = {
            "url": "http://localhost:8081/card",
            "method": "GET",
            "timeout": 0,
            "headers": {
              "Authorization": "Bearer " + localStorage["jwt"],
            },
          };

          const cardDetails = await $.ajax(settings);
          if (cardDetails.length > 0) {
            // fill in card details in checkout form
            $("#cc-name").val(cardDetails[0].card_name);
            $("#cc-number").val(cardDetails[0].card_num);
            formatCreditCardNumber(document.getElementById("cc-number"));
            $("#cc-expiration").val(cardDetails[0].card_expiry);

            // set checked save card details to true
            $("#save-card").prop("checked", true);
          }


          // get user's cart status to see if there is a cart with checkout status of false
          const cartData = await getUserCartData(localStorage["jwt"]);
          console.log(cartData)

          // ==================== EMPTY CART ====================
          // no cart data
          if (cartData === null || cartData.length < 1) {
            // display empty cart on page
            $("#cart-items").append(`
            <div class="row">
              <div class="col-12">
                <h3 class="text-center">Your cart is empty</h3>
                <h5 class="text-center">Continue browsing our games</h5>
              </div>
            </div>
            <div class="row">
              <div class="col-12 d-flex justify-content-center">
                <a class="btn btn-danger" id="back-to-games" href="./games.html">Game Store</a>
              </div>
            </div>
            `);

            $("#title-num-items").text("0 items")
          }

          // have cart data, hence populate cart with data
          else {
            // ==================== POPULATE CART ====================
            // set total cart items
            $("#title-num-items").text(cartData.length + " items");


            // ==================== POPULATE LEFT COL ====================
            // object to store prices to be used for right col (summary)
            var priceObj = {
              totalCost: 0
            };

            // main cart wrapper for left col
            let cartWrapper = $("#cart-items");

            // have cart but no items
            if (cartData[0].cart_data_id == null) {
              cartWrapper.append(`
              <div class="row">
                <div class="col-12">
                  <h3 class="text-center">Your cart is empty</h3>
                  <h5 class="text-center">Continue browsing our games</h5>
                </div>
              </div>
              <div class="row">
                <div class="col-12 d-flex justify-content-center">
                  <a class="btn btn-danger" id="back-to-games" href="./games.html">Game Store</a>
                </div>
              </div>
              `);

              $("#title-num-items").text("0 items")
            }

            else {
              // set items
              await cartData.forEach(async item => {
                let wrapper = $('<div class="row border-top" id="cart-gameid' + item.game_id + '"></div>');
                let rowWrapper = $('<div class="row main align-items center"></div>');

                // get game details first
                const gameData = await gameDetailsFromId(item.game_id);
                const gamePlatArr = String(gameData.platform_id).split(",");
                const gamePriceArr = String(gameData.price).split(",");
                let itemPrice;

                await gamePlatArr.forEach((plat, index) => {
                  if (Number(plat) === Number(item.platform_id)) {
                    itemPrice = gamePriceArr[index];
                  }
                });


                // set image
                let gameImg = $('<div class="col-2"><img class="img-fluid game-cart-img" src="./gameImage/' + gameData.img_name + '" alt="game image"></div>');


                // set title
                let titleWrapper = $('<div class="col"></div>');
                titleWrapper.append($('<div class="row text-muted>Game Item</div>'));

                // set platform icon
                let platformIdArr = [];
                let platformIconArr = [];
                if (!isNaN(Number(gameData.platform_id))) {
                  platformIdArr.push(gameData.platform_id);
                  platformIconArr.push(gameData.platform_icon);
                }

                else {
                  platformIdArr = gameData.platform_id.split(",");
                  platformIconArr = gameData.platform_icon.split(",");
                }
                let platformIcon;

                for (let i = 0; i < platformIdArr.length; i++) {
                  if (Number(platformIdArr[i]) === Number(item.platform_id)) {
                    platformIcon = platformIconArr[i];
                  }
                }
                titleWrapper.append($('<div class="row">' + gameData.title + '<i class="' + platformIcon + ' p-0" style="color: #000000; font-size: 3vh;"></i></div>'));

                // set quantity
                let quantityWrapper = $('<div class="col d-flex justify-content-center"></div>');
                let quantityForm = $('<form></form>');

                quantityForm.append($(`<input 
            type="number" 
            class="form-control game-item-quantity" 
            id="quantity-gameid${item.game_id}" 
            value="${item.quantity}">`));

                quantityWrapper.append(quantityForm);


                // set price and delete button
                let priceWrapper = $('<div class="col d-flex justify-content-between align-items-start"></div>');
                priceWrapper.text("S$" + itemPrice);
                let deleteButton = $('<button class="btn btn-transparent delete-item p-0" id="delete-' + item.game_id + '-' + item.platform_id + '"></button>');
                deleteButton.append($('<i class="fa-solid fa-trash" style="color: #000000;"></i>'));
                priceWrapper.append(deleteButton);

                // add to priceObj
                priceObj.totalCost += Number(itemPrice) * Number(item.quantity);
                priceObj[gameData.title] = (Number(itemPrice) * Number(item.quantity)).toFixed(2);


                // append to row wrapper
                rowWrapper.append(gameImg, titleWrapper, quantityWrapper, priceWrapper);
                wrapper.append(rowWrapper);
                cartWrapper.append(wrapper);


                // ==================== POPULATE RIGHT COL ====================
                // main cart wrapper for right col
                let summaryWrapper = $("#summary-items");

                // set total items
                $("#summary-num-items").text("ITEMS: " + cartData.length);
                $("#total-cost").text("S$ " + priceObj.totalCost.toFixed(2));

                let row = $('<div class="row d-flex justify-content-between my-2 p-0"></div>');
                let gameItem = $('<div class="col p-0">' + gameData.title + '</div>');
                let priceOfItem = $('<div class="col ps-2 text-end">S$ ' + (itemPrice * item.quantity).toFixed(2) + '</div>');

                row.append(gameItem, priceOfItem);
                summaryWrapper.append(row);

                // final cost (shipping free, hence same as total cost)
                $("#final-cost").text("S$ " + priceObj.totalCost.toFixed(2));


                // ==================== CHANGE QUANTITY EVENT ====================
                $(".game-item-quantity").on("input", function () {
                  // get game id
                  let updateQuantityGameId = Number($(this).attr("id").slice(15));

                  // get new quantity (prevent multiple AJAX calls)
                  if (item.game_id === updateQuantityGameId) {
                    let newQuantity = Number($(this).val());

                    // update cart
                    var settings = {
                      "url": "http://localhost:8081/cart/" + item.cart_id,
                      "method": "PUT",
                      "timeout": 0,
                      "headers": {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + localStorage["jwt"]
                      },
                      "data": JSON.stringify({
                        "game_id": updateQuantityGameId,
                        "platform_id": item.platform_id,
                        "quantity": newQuantity
                      }),
                    };

                    $.ajax(settings).done(function (response) {
                      console.log(response);

                      // handle error for update cart
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                      alert(jqXHR.status + " " + jqXHR.responseJSON.error);
                      if (jqXHR.status != 422) {
                        window.location.href = "./error/error" + jqXHR.status + ".html";
                      }
                    });
                  }
                });


                // ==================== DELETE ITEM EVENT ====================
                $(".delete-item").click(function () {
                  // get game id and platform id from button id
                  const deleteGameId = Number($(this).attr("id").slice(7, 8));
                  const deletePlatformId = Number($(this).attr("id").slice(9, 10));

                  if (item.game_id === deleteGameId) {
                    var settings = {
                      "url": "http://localhost:8081/cart/" + item.cart_id,
                      "method": "DELETE",
                      "timeout": 0,
                      "headers": {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + localStorage["jwt"]
                      },
                      "data": JSON.stringify({
                        "game_id": deleteGameId,
                        "platform_id": deletePlatformId
                      }),
                    };

                    $.ajax(settings).done(function (response) {
                      window.location.reload();

                      // handle error for delete cart item
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                      alert(jqXHR.status + " " + jqXHR.responseJSON.error);
                      if (jqXHR.status != 422) {
                        window.location.href = "./error/error" + jqXHR.status + ".html";
                      }
                    });
                  }
                });
              });
              $("#summary-items").append("<hr>");
            }
          }
        }

        catch (error) {
          const errorStatus = error.slice(0, 3);
          alert(error);
          if (errorStatus != 422) {
            window.location.href = "./error/error" + errorStatus + ".html";
          }
        }
      }

      // ==================== FORM SUBMISSION AT BOTTOM OF HTML PAGE ====================
    });
  </script>
  <link href="./css/cart.css" rel="stylesheet">
  <link href="./css/styles.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="./index.html">
        <img src="images/sp-games-logo.png" id="SPGLogo" alt="SPGLogo">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll"
        aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon bg-light"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarScroll">
        <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 40px;">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="index.html">Home</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="about.html">About</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="games.html">Games</a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="review.html" id="review-games">Reviews</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"
              id="admin-tools">
              Admin Tools
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="add-platform.html">Add Platform</a></li>
              <li><a class="dropdown-item" href="add-games.html">Add Game</a></li>
              <li><a class="dropdown-item" href="users.html">Edit User Data</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <form id="search-form">
              <div class="input-group mb-3">
                <input class="form-control ms-2" type="search" placeholder="Search games by name or filter by platform"
                  aria-label="Search" id="search-game" disabled>
                <span class="input-group-text" id="basic-addon1"><i class="fa-solid fa-magnifying-glass"></i></span>
              </div>
            </form>
          </li>
          <li class="nav-item">
            <div class="ms-2 dropdown" style="height: 100%;" id="filter-searchbar">
              <button class="btn btn-danger dropdown-toggle disabled" type="button" data-bs-toggle="dropdown"
                style="height: 100%;" id="filter-platform">
                Filter
              </button>
              <ul class="dropdown-menu bg-dark" id="filter-dropdown">
                <!-- populate with all platforms from db -->
                <li class="ms-2">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="platform" id="platform-All" checked>
                    <label class="form-check-label game-platforms" for="platform-All">All</label>
                  </div>
                </li>
              </ul>
            </div>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 40px;">
          <li>
            <div class="nav-item">
              <a href="./cart.html" class="nav-link me-2" id="cart">
                <i class="fa-solid fa-shopping-cart fa-lg"></i><span class="badge badge-light"
                  id="num-cart-items"></span>
              </a>
            </div>
          </li>
          <li>
            <div class="nav-item">
              <a href="profile.html" class="nav-link me-2" id="logged-in-user">
                <i class="fa-solid fa-user"></i>
              </a>
            </div>
          </li>
          <li>
            <div class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="login-dropdown" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="fa-solid fa-right-to-bracket"></i> Login / Sign Up
              </a>
              <ul class="dropdown-menu" aria-labelledby="login-dropdown">
                <li><a class="dropdown-item" href="login.html">Login</a></li>
                <li><a class="dropdown-item" href="login.html">Sign Up</a></li>
              </ul>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="mx-auto d-flex card justify-content-center mt-5">
    <div class="row">

      <!-- left column (cart items) -->
      <div class="col-md-8 cart" id="cart-items">
        <div class="title">
          <div class="row">
            <div class="col">
              <h4><b>Shopping Cart <i class="fa-solid fa-cart-shopping" style="color: #000000;"></i></b></h4>
            </div>
            <div class="col align-self-center text-right text-muted" id="title-num-items">3 items</div>
          </div>
        </div>
        <!-- <div class="row border-top">
          <div class="row main align-items-center">
            <div class="col-2"><img class="img-fluid" src="https://i.imgur.com/1GrakTl.jpg"></div>
            <div class="col">
              <div class="row text-muted">Game Item</div>
              <div class="row">Game 1</div>
            </div>
            <div class="col">
              <a href="#">-</a><a href="#" class="border">1</a><a href="#">+</a>
            </div>
            <div class="col">S$ 44.00
              <button class="btn btn-transparent delete-item" id="delete-item1">
                <i class="fa-solid fa-trash" style="color: #000000;"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="row border-top">
          <div class="row main align-items-center">
            <div class="col-2"><img class="img-fluid" src="https://i.imgur.com/ba3tvGm.jpg"></div>
            <div class="col">
              <div class="row text-muted">Game Item</div>
              <div class="row">Game 2</div>
            </div>
            <div class="col">
              <a href="#">-</a><a href="#" class="border">1</a><a href="#">+</a>
            </div>
            <div class="col">S$ 44.00
              <button class="btn btn-transparent delete-item" id="delete-item2">
                <i class="fa-solid fa-trash" style="color: #000000;"></i>
              </button>
            </div>
          </div>
        </div> -->
      </div>

      <!-- right column (summary) -->
      <div class="col-md-4 summary" id="cart-summary">
        <div>
          <h5><b>Summary</b></h5>
        </div>
        <hr>
        <div class="row" id="summary-items">
          <p class="col ps-0 text-dark mb-0" id="summary-num-items">ITEMS</p>
          <!-- <div class="col text-right" id="total-cost">S$ 132.00</div> -->
        </div>
        <form>
          <p class="text-dark pt-3 mb-2">SHIPPING <i class="fa-solid fa-truck-medical" style="color: #000000;"></i></p>
          <!-- medical truck for delivery for faster deliveries -->
          <select class="form-select">
            <option class="text-muted" id="delivery-cost-5">Standard-Delivery: FREE</option>
          </select>
        </form>
        <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
          <div class="col">TOTAL PRICE</div>
          <div class="col text-right" id="final-cost">S$ 137.00</div>
        </div>
        <button type="button" class="btn btn-light" id="checkout" data-bs-toggle="modal"
          data-bs-target="#checkout-details">CHECKOUT</button>
      </div>

      <!-- Modal for checkout -->
      <div class="modal fade" id="checkout-details" tabindex="-1" aria-labelledby="checkout-label" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="checkout-label">Checkout</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form class="needs-validation" novalidate="" id="checkout-form">
                <div class="row g-3">

                  <!-- First name -->
                  <div class="col-sm-6">
                    <label for="firstName" class="form-label">First name</label>
                    <input type="text" class="form-control" id="firstName" placeholder="" value="" required="">
                    <div class="invalid-feedback">
                      Valid first name is required.
                    </div>
                  </div>

                  <!-- Last name -->
                  <div class="col-sm-6">
                    <label for="lastName" class="form-label">Last name</label>
                    <input type="text" class="form-control" id="lastName" placeholder="" value="" required="">
                    <div class="invalid-feedback">
                      Valid last name is required.
                    </div>
                  </div>

                  <!-- Username -->
                  <div class="col-12">
                    <label for="username" class="form-label">Username</label>
                    <div class="input-group has-validation">
                      <span class="input-group-text">@</span>
                      <input type="text" class="form-control" id="username" placeholder="Username" required="">
                      <div class="invalid-feedback">
                        Your username is required.
                      </div>
                    </div>
                  </div>

                  <!-- Email -->
                  <div class="col-12">
                    <label for="email" class="form-label">Email <span class="text-muted">(Optional)</span></label>
                    <input type="email" class="form-control" id="email" placeholder="you@example.com">
                    <div class="invalid-feedback">
                      Please enter a valid email address for shipping updates.
                    </div>
                  </div>

                  <!-- Address -->
                  <div class="col-12">
                    <label for="address" class="form-label">Address</label>
                    <input type="text" class="form-control" id="address" placeholder="1234 Main St" required="">
                    <div class="invalid-feedback">
                      Please enter your shipping address.
                    </div>
                  </div>

                  <!-- Address 2 -->
                  <div class="col-12">
                    <label for="address2" class="form-label">Address 2 <span
                        class="text-muted">(Optional)</span></label>
                    <input type="text" class="form-control" id="address2" placeholder="Apartment or suite">
                  </div>

                  <!-- ZIP code -->
                  <div class="col-md-12">
                    <label for="zip" class="form-label">Zip</label>
                    <input pattern=".{6,6}" type="text" class="form-control" id="zip" placeholder="123456" required=""
                      maxlength="6" minlength="6">
                    <div class="invalid-feedback">
                      Zip code of 6 digits required.
                    </div>
                  </div>
                </div>

                <hr class="my-4">

                <!-- shipping address + billing address -->
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="same-address">
                  <label class="form-check-label" for="same-address">Shipping address is the same as my billing
                    address</label>
                </div>

                <!-- save credit card info -->
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="save-card">
                  <label class="form-check-label" for="save-card">Save credit card information for future
                    purchases</label>
                </div>

                <hr class="my-4">

                <h4 class="mb-3">Payment</h4>

                <!-- Payment methods -->
                <div class="my-3">
                  <div class="form-check">
                    <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked=""
                      required="">
                    <label class="form-check-label" for="credit">Credit card</label>
                  </div>
                  <div class="form-check">
                    <input id="debit" name="paymentMethod" type="radio" class="form-check-input" required="">
                    <label class="form-check-label" for="debit">Debit card</label>
                  </div>
                </div>

                <!-- Full name on card -->
                <div class="row gy-3">
                  <div class="col-md-6">
                    <label for="cc-name" class="form-label">Name on card</label>
                    <input type="text" class="form-control" id="cc-name" placeholder="Name" required="">
                    <small class="text-muted">Full name as displayed on card</small>
                    <div class="invalid-feedback">
                      Name on card is required
                    </div>
                  </div>

                  <!-- Credit card num -->
                  <div class="col-md-6">
                    <label for="cc-number" class="form-label">Credit card number</label>
                    <input pattern=".{19,19}" type="text" class="form-control" id="cc-number" maxlength="19"
                      minlength="19" placeholder="0000 0000 0000 0000" required="">
                    <div class="invalid-feedback">
                      Credit card number of 16 digits is required
                    </div>
                  </div>

                  <!-- Credit card expiration -->
                  <div class="col-md-6">
                    <label for="cc-expiration" class="form-label">Expiration</label>
                    <input pattern=".{7,7}" type="text" class="form-control" id="cc-expiration" maxlength="7"
                      minlength="7" placeholder="MM/YYYY" required="">
                    <div class="invalid-feedback">
                      Expiration date of "MM/YYYY" required
                    </div>
                  </div>

                  <!-- CVV -->
                  <div class="col-md-3">
                    <label for="cc-cvv" class="form-label">CVV</label>
                    <input pattern=".{3,3}" type="text" class="form-control" id="cc-cvv" maxlength="3" minlength="3"
                      placeholder="" required="">
                    <div class="invalid-feedback">
                      Security code of 3 digits required
                    </div>
                  </div>
                </div>

                <hr class="my-4">

                <button class="w-100 btn btn-primary btn-lg" type="submit" id="complete-checkout">Complete
                  Checkout</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==================== FORM SUBMISSION ====================
    (function () {
      'use strict'

      // Fetch all the forms we want to apply custom Bootstrap validation styles to
      var forms = document.querySelectorAll('.needs-validation')

      // Loop over them and prevent submission
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', async function (event) {
            // invalid form input
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }

            // valid form input
            else {
              event.preventDefault();

              // get form data (not sure if need)
              const formData = {
                "first_name": $("#first-name").val(),
                "last_name": $("#last-name").val(),
                "email": $("#email").val(),
                "phone": $("#phone").val(),
                "address1": $("#address1").val(),
                "address2": $("#address2").val(),
                "zip": $("#zip").val(),
                "same_address": $("#same-address").prop("checked"),
                "save_card": $("#save-card").prop("checked"),
                "payment_method": $("input[name='paymentMethod']:checked").val(),
                "cc_name": $("#cc-name").val(),
                "cc_number": $("#cc-number").val(),
                "cc_expiration": $("#cc-expiration").val(),
                "cc_cvv": $("#cc-cvv").val()
              }

              // logged in user checkout
              if (localStorage["jwt"]) {

                // get current cart data
                const cartData = await getUserCartData(localStorage["jwt"]);
                // confirmation
                const confirmation = "Are you sure you want to checkout?"

                // update checkout status in db
                if (confirm(confirmation)) {
                  var settings = {
                    "url": "http://localhost:8081/cart/" + cartData[0].cart_id + "/checkout",
                    "method": "PUT",
                    "timeout": 0,
                    "headers": {
                      "Authorization": "Bearer " + localStorage["jwt"]
                    },
                  };

                  $.ajax(settings).done(function (response) {
                    // check if user selected save card info
                    if ($("#save-card").prop("checked")) {
                      // save to db
                      var settings = {
                        "url": "http://localhost:8081/card",
                        "method": "POST",
                        "timeout": 0,
                        "headers": {
                          "Content-Type": "application/json",
                          "Authorization": "Bearer " + localStorage["jwt"]
                        },
                        "data": JSON.stringify({
                          "card_number": formData.cc_number,
                          "card_name": formData.cc_name,
                          "card_expiry": formData.cc_expiration,
                        }),
                      };

                      $.ajax(settings).done(function (response) {
                        alert("Checkout successful! Redirecting to homepage...");
                        window.location.href = "./index.html";

                        // handle error for save card
                      }).fail(function (jqXHR, textStatus, errorThrown) {
                        alert(jqXHR.status + " " + jqXHR.responseJSON.error);
                        if (jqXHR.status != 422) {
                          window.location.href = "./error/error" + jqXHR.status + ".html";
                        }
                      });
                    }

                    else {
                      alert("Checkout successful! Redirecting to homepage...");
                      window.location.href = "./index.html";
                    }

                    // handle error for checkout
                  }).fail(function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.status + " " + jqXHR.responseJSON.error);
                    if (jqXHR.status != 422) {
                      window.location.href = "./error/error" + jqXHR.status + ".html";
                    }
                  });
                }
              }

              // non logged in user checkout
              else {
                sessionStorage.removeItem("cart");
                alert("Checkout successful! Redirecting to homepage...");
                window.location.href = "./index.html";
              }
            }

            form.classList.add('was-validated');
          }, false);
        });
    })();


    // ==================== FORMATTING + ADDITIONAL FORM VALIDATION ====================
    // Function to format the credit card number with spaces
    function formatZIP(input) {
      const value = input.value.replace(/\D/g, ''); // Remove non-numeric characters
      const formattedValue = value.replace(/(\d{6})(?=\d)/, '$1');
      input.value = formattedValue;
    }

    $("#zip").on("input", function () {
      formatZIP(this);
    });


    // Function to format the credit card number with spaces
    function formatCreditCardNumber(input) {
      const value = input.value.replace(/\D/g, ''); // Remove existing spaces
      const formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 '); // Add space after every 4 digits
      input.value = formattedValue;
    }

    $("#cc-number").on("input", function () {
      formatCreditCardNumber(this);
    });


    // Function to format the expiry date with a "/"
    function formatExpiryDate(input) {
      const value = input.value.replace(/\D/g, ''); // Remove non-numeric characters
      const formattedValue = value.replace(/(\d{2})(?=\d)/, '$1/'); // Add "/" after the first 2 digits
      input.value = formattedValue;
    }

    $("#cc-expiration").on("input", function () {
      formatExpiryDate(this);
    });


    // Function to format the CVV with only numbers
    function formatCVV(input) {
      const value = input.value.replace(/\D/g, ''); // Remove non-numeric characters
      const formattedValue = value.replace(/(\d{3})(?=\d)/, '$1');
      input.value = formattedValue;
    }

    $("#cc-cvv").on("input", function () {
      formatCVV(this);
    });
  </script>
</body>

</html>
